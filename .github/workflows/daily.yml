name: daily

on:
  schedule:
    - cron: "30 9 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "override date (YYYY-MM-DD)"
        required: false
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    env:
      TZ: America/Sao_Paulo
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_SSLMODE: ${{ secrets.DB_SSLMODE }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: install uv
        run: python -m pip install uv

      - name: uv debug
        run: |
          uv --version
          which uv

      - name: install deps
        run: |
          uv sync
          uv pip install -e .

      - name: assert secrets
        run: |
          set -euo pipefail
          missing=0
          for var in DB_HOST DB_NAME DB_USER DB_PASSWORD; do
            if [ -z "${!var:-}" ]; then
              echo "::error::missing required GitHub secret: $var"
              missing=1
            fi
          done

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

          if [ -z "${DB_PORT:-}" ]; then
            echo "DB_PORT=5432" >> "$GITHUB_ENV"
          fi

          if [ -z "${DB_SSLMODE:-}" ]; then
            echo "DB_SSLMODE=prefer" >> "$GITHUB_ENV"
          fi

      - name: resolve date
        id: run_date
        run: |
          set -euo pipefail
          if [ -n "${{ github.event.inputs.date }}" ]; then
            date_str="${{ github.event.inputs.date }}"
            source="input"
          else
            date_str="$(TZ=America/Sao_Paulo date -d 'yesterday' +%F)"
            source="tz"
          fi

          if ! printf '%s' "$date_str" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
            echo "invalid date: $date_str (expected YYYY-MM-DD)" >&2
            exit 1
          fi

          echo "date=$date_str" >> "$GITHUB_OUTPUT"
          echo "source=$source" >> "$GITHUB_OUTPUT"

      - name: test persistent database connection
        run: |
          uv run python - <<'PY'
          import os
          import time
          import psycopg

          host = os.environ["DB_HOST"]
          port = os.getenv("DB_PORT", "5432")
          dbname = os.environ["DB_NAME"]
          user = os.environ["DB_USER"]
          password = os.environ["DB_PASSWORD"]
          sslmode = os.getenv("DB_SSLMODE", "prefer")

          err = None
          for _ in range(10):
            try:
              with psycopg.connect(
                host=host,
                port=port,
                dbname=dbname,
                user=user,
                password=password,
                sslmode=sslmode,
                connect_timeout=5,
              ) as conn:
                with conn.cursor() as cur:
                  cur.execute("select 1")
                  cur.fetchone()
              print(f"db connection ok | host={host} port={port} db={dbname} user={user} sslmode={sslmode}")
              raise SystemExit(0)
            except Exception as exc:
              err = exc
              time.sleep(3)

          raise SystemExit(f"db connection failed | host={host} port={port} db={dbname} user={user}: {err}")
          PY

      - name: run pipeline
        run: |
          date_str="${{ steps.run_date.outputs.date }}"
          uv run python -m etl.app run --date "$date_str" --checks --engine direct

      - name: validate marts dry-run
        run: |
          uv run python -m etl.validate_marts --apply-minimal --dry-run --engine direct

      - name: summarize run
        env:
          RUN_DATE: ${{ steps.run_date.outputs.date }}
        run: |
          uv run python - <<'PY'
          import os
          import psycopg

          run_date = os.environ["RUN_DATE"]
          host = os.environ["DB_HOST"]
          port = os.getenv("DB_PORT", "5432")
          dbname = os.environ["DB_NAME"]
          user = os.environ["DB_USER"]
          password = os.environ["DB_PASSWORD"]
          sslmode = os.getenv("DB_SSLMODE", "prefer")

          count = None
          with psycopg.connect(
            host=host,
            port=port,
            dbname=dbname,
            user=user,
            password=password,
            sslmode=sslmode,
            connect_timeout=5,
          ) as conn:
            with conn.cursor() as cur:
              cur.execute(
                "select count(*) from marts.mv_focos_day_dim where day = %s::date",
                (run_date,),
              )
              row = cur.fetchone()
              count = int(row[0] if row else 0)

          summary = os.getenv("GITHUB_STEP_SUMMARY")
          if summary:
            with open(summary, "a", encoding="utf-8") as fh:
              fh.write("## Daily ETL Summary\n")
              fh.write(f"- Date processed: `{run_date}`\n")
              fh.write(f"- Rows in `marts.mv_focos_day_dim` for date: `{count}`\n")
          print(f"summary | date={run_date} | mv_focos_day_dim_rows={count}")
          PY

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: reports-and-logs
          path: |
            data/logs/**
            data/reports/**
            docs/validation_last_run.md
          if-no-files-found: warn
