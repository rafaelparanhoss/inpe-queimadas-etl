name: daily

on:
  schedule:
    - cron: "30 9 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "override date (YYYY-MM-DD)"
        required: false
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    services:
      postgis:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_DB: geoetl
          POSTGRES_USER: geoetl
          POSTGRES_PASSWORD: geoetl
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U geoetl -d geoetl"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 20
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    env:
      TZ: America/Sao_Paulo
      DB_HOST: 127.0.0.1
      DB_PORT: "5432"
      DB_NAME: geoetl
      DB_USER: geoetl
      DB_PASSWORD: geoetl
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: install uv
        run: python -m pip install uv

      - name: uv debug
        run: |
          uv --version
          which uv

      - name: install deps
        run: |
          uv sync
          uv pip install -e .

      - name: wait for database
        run: |
          uv run python - <<'PY'
          import os
          import time
          import psycopg

          host = os.environ["DB_HOST"]
          port = os.environ["DB_PORT"]
          dbname = os.environ["DB_NAME"]
          user = os.environ["DB_USER"]
          password = os.environ["DB_PASSWORD"]

          err = None
          for _ in range(60):
              try:
                  conn = psycopg.connect(
                      host=host,
                      port=port,
                      dbname=dbname,
                      user=user,
                      password=password,
                      connect_timeout=3,
                  )
                  with conn, conn.cursor() as cur:
                      cur.execute("select 1")
                      cur.fetchone()
                  print("database ready")
                  raise SystemExit(0)
              except Exception as exc:
                  err = exc
                  time.sleep(2)

          raise SystemExit(f"database not ready after wait: {err}")
          PY

      - name: resolve db container id
        run: |
          db_container="$(docker ps --filter "ancestor=postgis/postgis:16-3.4" --format '{{.ID}}' | head -n1)"
          if [ -z "$db_container" ]; then
            echo "postgis container not found" >&2
            docker ps -a
            exit 1
          fi
          echo "DB_CONTAINER=$db_container" >> "$GITHUB_ENV"

      - name: resolve date
        id: run_date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            date_str="${{ github.event.inputs.date }}"
            source="input"
          else
            date_str="$(TZ=America/Sao_Paulo date -d 'yesterday' +%F)"
            source="tz"
          fi

          if ! printf '%s' "$date_str" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
            echo "invalid date: $date_str (expected YYYY-MM-DD)" >&2
            exit 1
          fi

          echo "date=$date_str" >> "$GITHUB_OUTPUT"
          echo "source=$source" >> "$GITHUB_OUTPUT"

      - name: run pipeline
        run: |
          date_str="${{ steps.run_date.outputs.date }}"
          uv run python -m etl.app run --date "$date_str" --checks --engine docker

      - name: validate marts dry-run
        run: |
          uv run python -m etl.validate_marts --apply-minimal --dry-run --engine direct

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: reports-and-logs
          path: |
            data/logs/**
            data/reports/**
            docs/validation_last_run.md
          if-no-files-found: warn
